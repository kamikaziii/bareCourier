# UX Audit Fixes Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Fix 11 UX audit findings covering dead routes, client feature gaps, shared components, pagination, and navigation consistency.

**Architecture:** Incremental changes across existing SvelteKit routes. Shared components (EmptyState, Pagination) built first, then applied. RLS migration needed for client edit. AppShell already supports the "More" drawer pattern — client just needs to use it.

**Tech Stack:** SvelteKit 2.50+ | Svelte 5 runes | Tailwind CSS v4 | shadcn-svelte | Supabase RLS

**Design Doc:** `docs/plans/2026-01-27-ux-audit-fixes-design.md`

---

## Phase 1: Quick Wins & Shared Components

### Task 1: Clean up dead routes

The redirects already exist in `+page.server.ts`. Just delete the leftover `+page.svelte` stubs and verify no nav links reference these paths.

**Files:**
- Delete: `src/routes/courier/reports/+page.svelte`
- Delete: `src/routes/courier/analytics/+page.svelte`
- Check: `src/routes/courier/+layout.svelte` (nav items)

**Step 1: Verify existing redirects work**

Run: `grep -r "redirect" src/routes/courier/reports/ src/routes/courier/analytics/`
Expected: Both `+page.server.ts` files contain `redirect(301, ...)`

**Step 2: Delete stub page components**

Delete `src/routes/courier/reports/+page.svelte` and `src/routes/courier/analytics/+page.svelte`.

**Step 3: Verify no nav links reference dead routes**

Run: `grep -r "/courier/reports\|/courier/analytics" src/routes/ src/lib/`
Expected: Only the `+page.server.ts` redirect files match. If any nav links found, remove them.

**Step 4: Verify app builds**

Run: `pnpm run check`
Expected: No errors.

**Step 5: Commit**

```bash
git add -A src/routes/courier/reports/ src/routes/courier/analytics/
git commit -m "chore: remove dead route stubs for reports and analytics"
```

---

### Task 2: Create shared EmptyState component

**Files:**
- Create: `src/lib/components/EmptyState.svelte`

**Step 1: Create the component**

Create `src/lib/components/EmptyState.svelte`:

```svelte
<script lang="ts">
	import { Button } from '$lib/components/ui/button/index.js';
	import type { Component } from 'svelte';

	let {
		icon: Icon,
		title,
		description = '',
		actionLabel = '',
		actionHref = '',
		onAction
	}: {
		icon?: Component<{ class?: string }>;
		title: string;
		description?: string;
		actionLabel?: string;
		actionHref?: string;
		onAction?: () => void;
	} = $props();
</script>

<div class="flex flex-col items-center justify-center py-12 text-center">
	{#if Icon}
		<Icon class="text-muted-foreground mb-4 size-12" />
	{/if}
	<h3 class="text-lg font-semibold">{title}</h3>
	{#if description}
		<p class="text-muted-foreground mt-1 max-w-sm text-sm">{description}</p>
	{/if}
	{#if actionLabel && (actionHref || onAction)}
		<Button variant="outline" class="mt-4" href={actionHref || undefined} onclick={onAction}>
			{actionLabel}
		</Button>
	{/if}
</div>
```

**Step 2: Verify it compiles**

Run: `pnpm run check`
Expected: No errors.

**Step 3: Commit**

```bash
git add src/lib/components/EmptyState.svelte
git commit -m "feat: add shared EmptyState component"
```

---

### Task 3: Install shadcn-svelte Pagination component

**Files:**
- Create: `src/lib/components/ui/pagination/` (auto-generated by shadcn CLI)

**Step 1: Install pagination**

Run: `pnpm dlx shadcn-svelte@latest add pagination --yes`
Expected: Files created in `src/lib/components/ui/pagination/`

**Step 2: Verify it compiles**

Run: `pnpm run check`
Expected: No errors.

**Step 3: Commit**

```bash
git add src/lib/components/ui/pagination/
git commit -m "feat: add shadcn-svelte pagination component"
```

---

### Task 4: Align client settings responsive pattern

Currently courier settings uses Tabs (desktop) + native dropdown (mobile). Client settings uses flat Card layout with no tabs. Refactor client settings to use the same tab + dropdown pattern with 3 tabs: Profile, Location, Notifications.

**Files:**
- Modify: `src/routes/client/settings/+page.svelte`

**Step 1: Read both settings files to confirm the gap**

Read `src/routes/courier/settings/+page.svelte` (102 lines) and `src/routes/client/settings/+page.svelte` (100 lines). Courier uses `Tabs.Root` on desktop and `<select>` on mobile. Client uses flat cards.

**Step 2: Refactor client settings to tab + dropdown pattern**

Restructure `src/routes/client/settings/+page.svelte` to match courier pattern:
- Import `Tabs` from shadcn-svelte
- Create 3 tabs: `profile` (name, phone, email), `location` (default pickup), `notifications` (NotificationsTab)
- Desktop: `Tabs.Root` with `Tabs.List` + `Tabs.Trigger` + `Tabs.Content`
- Mobile: `<select>` dropdown with conditional rendering
- URL-driven: read `?tab=` from `$page.url.searchParams`, default to `profile`
- `setTab(tab)` function using `goto()` with `replaceState`, `noScroll`, `keepFocus`

**Step 3: Verify both settings pages look consistent**

Run: `pnpm run dev` and visually check `/client/settings` on desktop and mobile viewport.

**Step 4: Verify build**

Run: `pnpm run check`
Expected: No errors.

**Step 5: Commit**

```bash
git add src/routes/client/settings/+page.svelte
git commit -m "refactor: align client settings to tab+dropdown responsive pattern"
```

---

## Phase 2: Client Dashboard Enhancements

### Task 5: Add sort dropdown to client dashboard

**Files:**
- Modify: `src/routes/client/+page.svelte`

**Step 1: Add sort state and dropdown**

In `src/routes/client/+page.svelte`, add after the existing filter state variables:

```typescript
let sortBy = $state<'newest' | 'oldest' | 'pending-first' | 'delivered-first'>('newest');
```

Add a sort function:

```typescript
function sortServices(list: typeof services) {
	return [...list].sort((a, b) => {
		switch (sortBy) {
			case 'newest':
				return new Date(b.created_at).getTime() - new Date(a.created_at).getTime();
			case 'oldest':
				return new Date(a.created_at).getTime() - new Date(b.created_at).getTime();
			case 'pending-first':
				return (a.status === 'pending' ? 0 : 1) - (b.status === 'pending' ? 0 : 1);
			case 'delivered-first':
				return (a.status === 'delivered' ? 0 : 1) - (b.status === 'delivered' ? 0 : 1);
			default:
				return 0;
		}
	});
}
```

Update the `filteredServices` derived to pipe through sort:

```typescript
const sortedServices = $derived(sortServices(filteredServices));
```

Replace all references to `filteredServices` in the template with `sortedServices` (except the filter logic itself).

Add a `<select>` dropdown in the filter area:

```svelte
<select
	class="border-input bg-background rounded-md border px-3 py-2 text-sm"
	bind:value={sortBy}
>
	<option value="newest">Newest first</option>
	<option value="oldest">Oldest first</option>
	<option value="pending-first">Pending first</option>
	<option value="delivered-first">Delivered first</option>
</select>
```

**Step 2: Verify sort works**

Run: `pnpm run dev`, navigate to `/client`, toggle sort options. Confirm list reorders.

**Step 3: Verify build**

Run: `pnpm run check`

**Step 4: Commit**

```bash
git add src/routes/client/+page.svelte
git commit -m "feat: add sort dropdown to client dashboard"
```

---

### Task 6: Add "Needs attention" section to client dashboard

The client dashboard already has a `suggestedServices` derived and a suggestion dialog. This task elevates that into a prominent top section and adds rejected services.

**Files:**
- Modify: `src/routes/client/+page.svelte`

**Step 1: Add rejected services derived**

```typescript
const rejectedServices = $derived(
	services.filter((s) => s.request_status === 'rejected' && s.status === 'pending')
);
const attentionServices = $derived([...suggestedServices, ...rejectedServices]);
```

**Step 2: Add "Needs attention" section in the template**

Place above the stats section, after the header. Only render when `attentionServices.length > 0`:

```svelte
{#if attentionServices.length > 0}
	<div class="space-y-3">
		<h2 class="text-sm font-semibold text-orange-600">
			Needs your attention ({attentionServices.length})
		</h2>
		{#each attentionServices as service}
			<Card.Root class="border-orange-200 bg-orange-50 dark:border-orange-900 dark:bg-orange-950/30">
				<Card.Content class="p-4">
					<div class="flex items-start justify-between gap-3">
						<div class="min-w-0 flex-1">
							<p class="text-sm font-medium truncate">
								{service.pickup_location} → {service.delivery_location}
							</p>
							{#if service.request_status === 'suggested'}
								<p class="text-muted-foreground mt-1 text-xs">
									Courier suggested a new date
								</p>
							{:else if service.request_status === 'rejected'}
								<p class="text-muted-foreground mt-1 text-xs">
									Request was declined
								</p>
							{/if}
						</div>
						<div class="flex gap-2">
							{#if service.request_status === 'suggested'}
								<Button size="sm" onclick={() => openSuggestionDialog(service)}>
									Respond
								</Button>
							{:else if service.request_status === 'rejected'}
								<Button size="sm" variant="outline" href="/client/new">
									Re-submit
								</Button>
							{/if}
						</div>
					</div>
				</Card.Content>
			</Card.Root>
		{/each}
	</div>
{/if}
```

**Step 3: Verify the section appears**

Run: `pnpm run dev`. If test data has suggested/rejected services, the section should appear.

**Step 4: Verify build**

Run: `pnpm run check`

**Step 5: Commit**

```bash
git add src/routes/client/+page.svelte
git commit -m "feat: add needs-attention section to client dashboard"
```

---

### Task 7: Add batch accept/decline for suggestions

Reuse the existing `useBatchSelection` composable from `src/lib/composables/use-batch-selection.svelte.ts`.

**Files:**
- Modify: `src/routes/client/+page.svelte`

**Step 1: Import and initialize batch selection**

```typescript
import { useBatchSelection } from '$lib/composables/use-batch-selection.svelte';

const suggestionBatch = useBatchSelection();
```

**Step 2: Add checkboxes to suggestion cards**

In the "Needs attention" section, add a checkbox to each suggested service card (only for `request_status === 'suggested'`):

```svelte
{#if service.request_status === 'suggested'}
	<input
		type="checkbox"
		checked={suggestionBatch.has(service.id)}
		onchange={() => suggestionBatch.toggle(service.id)}
		class="mt-1 shrink-0"
	/>
{/if}
```

**Step 3: Add floating action bar**

Below the attention section, when `suggestionBatch.hasSelection`:

```svelte
{#if suggestionBatch.hasSelection}
	<div class="bg-background sticky bottom-16 z-10 flex items-center gap-2 rounded-lg border p-3 shadow-lg">
		<span class="text-muted-foreground text-sm">
			{suggestionBatch.selectedCount} selected
		</span>
		<div class="ml-auto flex gap-2">
			<Button size="sm" onclick={handleBatchAcceptSuggestions}>
				Accept all
			</Button>
			<Button size="sm" variant="outline" onclick={() => (showBatchDeclineDialog = true)}>
				Decline all
			</Button>
		</div>
	</div>
{/if}
```

**Step 4: Add batch action handlers**

```typescript
let showBatchDeclineDialog = $state(false);
let batchDeclineReason = $state('');
let batchActionLoading = $state(false);

async function handleBatchAcceptSuggestions() {
	batchActionLoading = true;
	const ids = [...suggestionBatch.selectedIds];
	for (const id of ids) {
		await data.supabase
			.from('services')
			.update({
				request_status: 'accepted',
				scheduled_date: services.find((s) => s.id === id)?.suggested_date,
				scheduled_time_slot: services.find((s) => s.id === id)?.suggested_time_slot
			})
			.eq('id', id);
	}
	suggestionBatch.reset();
	batchActionLoading = false;
	await loadServices();
}

async function handleBatchDeclineSuggestions() {
	batchActionLoading = true;
	const ids = [...suggestionBatch.selectedIds];
	for (const id of ids) {
		await data.supabase
			.from('services')
			.update({ request_status: 'pending' })
			.eq('id', id);
	}
	suggestionBatch.reset();
	showBatchDeclineDialog = false;
	batchDeclineReason = '';
	batchActionLoading = false;
	await loadServices();
}
```

Add a `Dialog` for batch decline with a reason textarea (reuse existing Dialog import).

**Step 5: Verify batch operations work**

Run: `pnpm run dev`, select multiple suggestions, test accept all and decline all.

**Step 6: Verify build**

Run: `pnpm run check`

**Step 7: Commit**

```bash
git add src/routes/client/+page.svelte
git commit -m "feat: add batch accept/decline for client suggestions"
```

---

### Task 8: Add pagination to client dashboard

**Files:**
- Modify: `src/routes/client/+page.svelte`

**Step 1: Add pagination state**

```typescript
import * as Pagination from '$lib/components/ui/pagination/index.js';

const PAGE_SIZE = 20;
let currentPage = $state(1);
const totalPages = $derived(Math.ceil(sortedServices.length / PAGE_SIZE));
const paginatedServices = $derived(
	sortedServices.slice((currentPage - 1) * PAGE_SIZE, currentPage * PAGE_SIZE)
);
```

Reset `currentPage = 1` whenever filters or sort change — add to `clearFilters()` and watch `sortBy`:

```typescript
$effect(() => {
	// Reset pagination when filters change
	statusFilter; dateFilter; searchQuery; dateFrom; dateTo; sortBy;
	currentPage = 1;
});
```

**Step 2: Replace `sortedServices` with `paginatedServices` in template**

In the `{#each}` block that renders services, use `paginatedServices` instead of `sortedServices`.

**Step 3: Add pagination controls below the list**

```svelte
{#if totalPages > 1}
	<div class="flex items-center justify-center gap-2 py-4">
		<Button
			variant="outline"
			size="sm"
			disabled={currentPage === 1}
			onclick={() => (currentPage = currentPage - 1)}
		>
			Previous
		</Button>
		<span class="text-muted-foreground text-sm">
			Page {currentPage} of {totalPages}
		</span>
		<Button
			variant="outline"
			size="sm"
			disabled={currentPage === totalPages}
			onclick={() => (currentPage = currentPage + 1)}
		>
			Next
		</Button>
	</div>
{/if}
```

**Step 4: Verify pagination works**

Run: `pnpm run dev`. If there are >20 services, pagination should appear.

**Step 5: Verify build**

Run: `pnpm run check`

**Step 6: Commit**

```bash
git add src/routes/client/+page.svelte
git commit -m "feat: add pagination to client dashboard"
```

---

## Phase 3: Navigation & Route Restructuring

### Task 9: Update client nav to use "More" drawer

The `AppShell` already accepts `moreItems` prop. Client layout just needs to split nav items into `bottomNavItems` and `moreItems`.

**Files:**
- Modify: `src/routes/client/+layout.svelte`

**Step 1: Split nav items**

In `src/routes/client/+layout.svelte`, change from passing all items as both `sidebarItems` and `bottomNavItems` to splitting them:

```typescript
// All nav items (sidebar uses all)
const allNavItems = [
	{ href: '/client', label: m.my_services(), icon: Package, badge: suggestedServices > 0 ? suggestedServices : undefined },
	{ href: '/client/new', label: m.new_request(), icon: PlusCircle },
	{ href: '/client/calendar', label: m.calendar(), icon: Calendar },
	{ href: '/client/billing', label: m.billing(), icon: Receipt },
	{ href: '/client/settings', label: m.settings(), icon: Settings }
];

// Bottom nav shows first 4
const bottomNavItems = allNavItems.slice(0, 4);

// More drawer gets the rest
const moreItems = allNavItems.slice(4);
```

Add `Calendar` to the Lucide imports:

```typescript
import { Package, PlusCircle, Receipt, Settings, Calendar } from 'lucide-svelte';
```

Update the `AppShell` usage:

```svelte
<AppShell
	profile={data.profile}
	role="client"
	supabase={data.supabase}
	sidebarItems={allNavItems}
	{bottomNavItems}
	{moreItems}
	sidebarCollapsed={data.sidebarCollapsed}
>
	{@render children()}
</AppShell>
```

**Step 2: Check i18n key for calendar**

Verify `m.calendar()` exists. If not, check what the courier layout uses and use the same key. Grep for `calendar` in the paraglide messages.

**Step 3: Verify nav renders correctly**

Run: `pnpm run dev`, check client mobile nav shows 4 items + "More" drawer with Settings.

**Step 4: Verify build**

Run: `pnpm run check`

**Step 5: Commit**

```bash
git add src/routes/client/+layout.svelte
git commit -m "feat: update client nav with calendar link and More drawer"
```

---

### Task 10: Move courier service creation to `/courier/services/new`

Extract the inline create form from `src/routes/courier/services/+page.svelte` (568 lines) into a dedicated route.

**Files:**
- Create: `src/routes/courier/services/new/+page.svelte`
- Create: `src/routes/courier/services/new/+page.ts`
- Create: `src/routes/courier/services/new/+page.server.ts` (form action)
- Modify: `src/routes/courier/services/+page.svelte` (remove form, add link button)

**Step 1: Read the existing courier services page to identify the form section**

Read `src/routes/courier/services/+page.svelte`. The form is toggled by `showForm` state. Identify:
- All state variables related to the form (lines with `selectedClientId`, `pickupLocation`, `deliveryLocation`, etc.)
- The form template section (wrapped in `{#if showForm}`)
- The `handleFormSubmit` function
- The `handleClientSelect`, `handlePickupSelect`, `handleDeliverySelect` functions
- Data loading for clients, urgency fees, courier settings

**Step 2: Create the data loader**

Create `src/routes/courier/services/new/+page.ts`:

```typescript
import type { PageLoad } from './$types';

export const load: PageLoad = async ({ parent }) => {
	const { supabase } = await parent();
	return { supabase };
};
```

**Step 3: Move form action**

Check if `src/routes/courier/services/+page.server.ts` has the form action for service creation. If so, duplicate the relevant action into `src/routes/courier/services/new/+page.server.ts`. The list page's actions (like `batchStatusChange`) stay on the list page.

**Step 4: Create the new page component**

Create `src/routes/courier/services/new/+page.svelte` with:
- All form-related state variables extracted from the services page
- All form-related imports (AddressInput, RouteMap, SchedulePicker, UrgencyFeeSelect, etc.)
- The form template
- All form handler functions
- Header with back button to `/courier/services`
- `loadData()` function for clients, urgency fees, courier settings

**Step 5: Simplify the services list page**

In `src/routes/courier/services/+page.svelte`:
- Remove all form-related state variables
- Remove form template section
- Remove form handler functions
- Remove imports only used by the form (SchedulePicker, UrgencyFeeSelect, etc.)
- Change the "New" button from toggling `showForm` to `href="/courier/services/new"`
- Keep: service list, filters, batch selection, CSV export

**Step 6: Verify both pages work**

Run: `pnpm run dev`
- `/courier/services` — list without form, "New Service" button links to new page
- `/courier/services/new` — full creation form, submit creates service, redirects back

**Step 7: Verify build**

Run: `pnpm run check`

**Step 8: Commit**

```bash
git add src/routes/courier/services/
git commit -m "refactor: move courier service creation to /courier/services/new"
```

---

### Task 11: Add client calendar route

**Files:**
- Create: `src/routes/client/calendar/+page.svelte`
- Create: `src/routes/client/calendar/+page.ts`

**Step 1: Create the data loader**

Create `src/routes/client/calendar/+page.ts`:

```typescript
import type { PageLoad } from './$types';

export const load: PageLoad = async ({ parent, url }) => {
	const { supabase } = await parent();
	const currentMonth = url.searchParams.get('month') || new Date().toISOString().slice(0, 7);

	// Parse month to get date range
	const [year, month] = currentMonth.split('-').map(Number);
	const startDate = new Date(year, month - 1, 1);
	const endDate = new Date(year, month + 1, 0); // last day of month

	// Pad with prev/next month days (6-week grid = 42 days)
	const paddedStart = new Date(startDate);
	paddedStart.setDate(paddedStart.getDate() - paddedStart.getDay() + 1); // Monday
	if (paddedStart > startDate) paddedStart.setDate(paddedStart.getDate() - 7);

	const paddedEnd = new Date(paddedStart);
	paddedEnd.setDate(paddedEnd.getDate() + 41); // 42 days

	const { data: services } = await supabase
		.from('services')
		.select('id, pickup_location, delivery_location, status, scheduled_date, created_at, request_status')
		.gte('scheduled_date', paddedStart.toISOString().slice(0, 10))
		.lte('scheduled_date', paddedEnd.toISOString().slice(0, 10))
		.is('deleted_at', null)
		.order('created_at', { ascending: true });

	return { services: services || [], currentMonth };
};
```

**Step 2: Create the page component**

Create `src/routes/client/calendar/+page.svelte`. Follow the same pattern as `src/routes/courier/calendar/+page.svelte` (365 lines) but simplified:
- Same 6-week grid layout (42 cells)
- Same month navigation (prev/today/next with URL params)
- Same service dots (blue=pending, green=delivered)
- Same day selection → side panel with service list
- Remove: status-change actions, batch operations, past-due settings
- Service links go to `/client/services/[id]` instead of `/courier/services/[id]`

Read the courier calendar carefully and adapt. Key changes:
- No `data.profile.past_due_settings` usage
- No UrgencyBadge or status-change buttons
- Service card links use `/client/services/${service.id}`
- Simpler header (no batch actions)

**Step 3: Verify calendar renders**

Run: `pnpm run dev`, navigate to `/client/calendar`. Verify grid renders, month nav works, day selection shows services.

**Step 4: Verify build**

Run: `pnpm run check`

**Step 5: Commit**

```bash
git add src/routes/client/calendar/
git commit -m "feat: add read-only calendar view for client"
```

---

## Phase 4: Client Edit & Database Changes

### Task 12: Add RLS migration for client service edits

The existing trigger `check_client_service_update_fields` (Migration 023) blocks clients from modifying location/notes fields. We need to allow edits when `request_status = 'pending'`.

**Files:**
- Create: migration via `mcp__supabase__apply_migration`

**Step 1: Read the existing trigger function**

Read migration 023 to understand `check_client_service_update_fields()`. The trigger restricts which columns a client can change. We need to modify it to allow location/notes/schedule changes ONLY when the **old** `request_status = 'pending'`.

**Step 2: Apply migration**

Use `mcp__supabase__apply_migration` with name `allow_client_edit_pending_services`:

```sql
CREATE OR REPLACE FUNCTION check_client_service_update_fields()
RETURNS TRIGGER AS $$
BEGIN
  -- If user is courier, allow all changes
  IF public.is_courier() THEN
    RETURN NEW;
  END IF;

  -- If service is pending (not yet accepted by courier), allow editing
  -- location, notes, and scheduling fields
  IF OLD.request_status = 'pending' THEN
    -- Still restrict pricing and status fields
    IF NEW.calculated_price IS DISTINCT FROM OLD.calculated_price
       OR NEW.price_breakdown IS DISTINCT FROM OLD.price_breakdown
       OR NEW.status IS DISTINCT FROM OLD.status
       OR NEW.delivered_at IS DISTINCT FROM OLD.delivered_at
       OR NEW.scheduled_date IS DISTINCT FROM OLD.scheduled_date
       OR NEW.scheduled_time_slot IS DISTINCT FROM OLD.scheduled_time_slot
       OR NEW.suggested_date IS DISTINCT FROM OLD.suggested_date
       OR NEW.suggested_time_slot IS DISTINCT FROM OLD.suggested_time_slot
    THEN
      RAISE EXCEPTION 'Clients cannot modify pricing, status, or courier scheduling fields';
    END IF;
    RETURN NEW;
  END IF;

  -- For non-pending services, keep original restrictions
  -- (only allow request_status, deleted_at, reschedule fields)
  IF NEW.pickup_location IS DISTINCT FROM OLD.pickup_location
     OR NEW.delivery_location IS DISTINCT FROM OLD.delivery_location
     OR NEW.pickup_lat IS DISTINCT FROM OLD.pickup_lat
     OR NEW.pickup_lng IS DISTINCT FROM OLD.pickup_lng
     OR NEW.delivery_lat IS DISTINCT FROM OLD.delivery_lat
     OR NEW.delivery_lng IS DISTINCT FROM OLD.delivery_lng
     OR NEW.distance_km IS DISTINCT FROM OLD.distance_km
     OR NEW.notes IS DISTINCT FROM OLD.notes
     OR NEW.calculated_price IS DISTINCT FROM OLD.calculated_price
     OR NEW.price_breakdown IS DISTINCT FROM OLD.price_breakdown
     OR NEW.status IS DISTINCT FROM OLD.status
     OR NEW.delivered_at IS DISTINCT FROM OLD.delivered_at
     OR NEW.scheduled_date IS DISTINCT FROM OLD.scheduled_date
     OR NEW.scheduled_time_slot IS DISTINCT FROM OLD.scheduled_time_slot
     OR NEW.suggested_date IS DISTINCT FROM OLD.suggested_date
     OR NEW.suggested_time_slot IS DISTINCT FROM OLD.suggested_time_slot
  THEN
    RAISE EXCEPTION 'Clients can only update request_status, deleted_at, and reschedule fields for non-pending services';
  END IF;

  RETURN NEW;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;
```

**Step 3: Verify security**

Run: `mcp__supabase__get_advisors(type: "security")`
Expected: No new security issues.

**Step 4: Commit migration file**

```bash
git add supabase/migrations/
git commit -m "feat: allow client edits on pending service requests"
```

---

### Task 13: Create `/client/services/[id]/edit` route

**Files:**
- Create: `src/routes/client/services/[id]/edit/+page.svelte`
- Create: `src/routes/client/services/[id]/edit/+page.ts`
- Create: `src/routes/client/services/[id]/edit/+page.server.ts`
- Modify: `src/routes/client/services/[id]/+page.svelte` (add edit button)

**Step 1: Create the data loader**

Create `src/routes/client/services/[id]/edit/+page.ts`:

```typescript
import type { PageLoad } from './$types';
import { redirect } from '@sveltejs/kit';

export const load: PageLoad = async ({ params, parent }) => {
	const { supabase } = await parent();

	const { data: service } = await supabase
		.from('services')
		.select('*')
		.eq('id', params.id)
		.single();

	if (!service || service.request_status !== 'pending') {
		redirect(303, `/client/services/${params.id}`);
	}

	return { service, supabase };
};
```

**Step 2: Create the form action**

Create `src/routes/client/services/[id]/edit/+page.server.ts`. Model after `src/routes/client/new/+page.server.ts` but use UPDATE instead of INSERT:

- Read form data (pickup_location, delivery_location, notes, requested_date, requested_time_slot, coordinates)
- Recalculate distance if coordinates changed
- Recalculate price if distance changed
- Update the service record
- Redirect to `/client/services/[id]`

**Step 3: Create the edit page component**

Create `src/routes/client/services/[id]/edit/+page.svelte`. Reuse the form structure from `src/routes/client/new/+page.svelte` with these changes:
- Pre-populate all fields from `data.service`
- Page title: "Edit Service Request"
- Submit button: "Save Changes"
- Cancel button: link to `/client/services/[id]`
- Form action: `?/default` (or named action)

**Step 4: Add edit button to service detail page**

In `src/routes/client/services/[id]/+page.svelte`, add an edit button in the header area. Only show when `data.service.request_status === 'pending'`:

```svelte
{#if data.service.request_status === 'pending'}
	<Button variant="outline" size="sm" href={`/client/services/${data.service.id}/edit`}>
		Edit
	</Button>
{/if}
```

**Step 5: Verify edit flow**

Run: `pnpm run dev`
1. Create a service request as client
2. View service detail → Edit button visible
3. Click edit → form pre-populated
4. Change delivery location → Save
5. Verify changes persisted
6. Have courier accept the request → Edit button disappears

**Step 6: Verify build**

Run: `pnpm run check`

**Step 7: Commit**

```bash
git add src/routes/client/services/
git commit -m "feat: add client edit for pending service requests"
```

---

## Phase 5: Pagination Rollout

### Task 14: Add pagination to `/courier/services`

**Files:**
- Modify: `src/routes/courier/services/+page.svelte`

**Step 1: Add pagination state**

Same pattern as Task 8 (client dashboard). Add:
- `currentPage` state
- `PAGE_SIZE = 20`
- `paginatedServices` derived from filtered list
- Reset page on filter change
- Pagination controls below list

**Step 2: Verify and commit**

Run: `pnpm run check`

```bash
git add src/routes/courier/services/+page.svelte
git commit -m "feat: add pagination to courier services list"
```

---

### Task 15: Add pagination to `/courier/billing`

**Files:**
- Modify: `src/routes/courier/billing/+page.svelte`

**Step 1: Read the billing page**

Read `src/routes/courier/billing/+page.svelte` to understand the data structure. The billing page shows a client summary table, not individual services. Paginate the client rows.

**Step 2: Add pagination**

Same pattern: `currentPage`, `PAGE_SIZE = 20`, `paginatedClients` derived, pagination controls.

**Step 3: Verify and commit**

Run: `pnpm run check`

```bash
git add src/routes/courier/billing/+page.svelte
git commit -m "feat: add pagination to courier billing page"
```

---

### Task 16: Add pagination to `/client/billing`

**Files:**
- Modify: `src/routes/client/billing/+page.svelte`

**Step 1: Read the billing page**

Read `src/routes/client/billing/+page.svelte`. Paginate the services table.

**Step 2: Add pagination**

Same pattern as above.

**Step 3: Verify and commit**

Run: `pnpm run check`

```bash
git add src/routes/client/billing/+page.svelte
git commit -m "feat: add pagination to client billing page"
```

---

## Phase 6: Apply EmptyState Component

### Task 17: Replace ad-hoc empty states across all list pages

**Files:**
- Modify: `src/routes/courier/services/+page.svelte`
- Modify: `src/routes/courier/requests/+page.svelte`
- Modify: `src/routes/courier/clients/+page.svelte`
- Modify: `src/routes/courier/billing/+page.svelte`
- Modify: `src/routes/client/+page.svelte`
- Modify: `src/routes/client/billing/+page.svelte`
- Modify: `src/routes/client/calendar/+page.svelte`

**Step 1: Search for existing empty states**

Run: `grep -rn "No services\|No clients\|No billing\|No pending\|No requests" src/routes/`
This reveals all ad-hoc empty state text.

**Step 2: Replace each with EmptyState component**

For each page, import `EmptyState` and replace the ad-hoc empty state markup. Use appropriate icons and CTAs:

| Page | Icon | Title | CTA |
|------|------|-------|-----|
| Courier services | Package | "No services found" | "New Service" → `/courier/services/new` |
| Courier requests | Inbox | "No pending requests" | (none) |
| Courier clients | Users | "No clients yet" | "Add Client" → scroll to form |
| Courier billing | Receipt | "No billing data" | (none) |
| Client dashboard | Package | "No services yet" | "Create Request" → `/client/new` |
| Client billing | Receipt | "No billing data" | (none) |
| Client calendar | Calendar | "No services this month" | (none) |

**Step 3: Verify all empty states render correctly**

Run: `pnpm run dev` and check each page with no data.

**Step 4: Verify build**

Run: `pnpm run check`

**Step 5: Commit**

```bash
git add src/routes/ src/lib/components/EmptyState.svelte
git commit -m "refactor: replace ad-hoc empty states with shared EmptyState component"
```

---

## Completion Checklist

- [x] Phase 1: Dead routes cleaned, EmptyState created, Pagination installed, client settings aligned
- [x] Phase 2: Sort dropdown, needs-attention section, batch ops, client pagination
- [x] Phase 3: Client nav updated, courier create extracted, client calendar added
- [x] Phase 4: RLS migration applied, client edit route created
- [x] Phase 5: Pagination on courier services, courier billing, client billing
- [x] Phase 6: EmptyState applied to all list pages
- [x] `pnpm run check` passes (0 errors, 2 pre-existing warnings)
- [ ] `pnpm run build` succeeds
